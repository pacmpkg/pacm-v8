name: Update V8 Prebuilts

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.compute.outputs.version }}
      commit: ${{ steps.compute.outputs.commit }}
      should_build: ${{ steps.filter.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Allow git access to v8 directory
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE/third_party/v8"

      - name: Fetch upstream V8 state
        run: git -C third_party/v8 fetch --tags origin

      - name: Determine latest V8 version
        id: compute
        run: python3 scripts/extract_v8_version.py --repo third_party/v8 --mode latest-tag --output "$GITHUB_OUTPUT"

      - name: Check for existing release
        id: filter
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.compute.outputs.version }}
        with:
          script: |
            const version = process.env.VERSION;
            if (!version) {
              core.warning('No V8 version detected; skipping build.');
              core.setOutput('should_build', 'false');
              return;
            }
            const tag = `v8-${version}`;
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag,
              });
              core.info(`Release ${tag} already exists.`);
              core.setOutput('should_build', 'false');
            } catch (error) {
              if (error.status === 404) {
                core.info(`No release ${tag} found; building.`);
                core.setOutput('should_build', 'true');
              } else {
                throw error;
              }
            }

  build:
    needs: detect
    if: ${{ needs.detect.outputs.should_build == 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            gn_target: x64.release
            target_triple: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            gn_target: arm64.release
            target_triple: aarch64-unknown-linux-gnu
          - os: ubuntu-latest
            gn_target: ia32.release
            target_triple: i686-unknown-linux-gnu
          - os: macos-latest
            gn_target: arm64.release
            target_triple: aarch64-apple-darwin
          - os: macos-15
            gn_target: x64.release
            target_triple: x86_64-apple-darwin
          - os: windows-latest
            gn_target: x64.release
            target_triple: x86_64-pc-windows-msvc
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Configure Git safe directories
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global --add safe.directory "$GITHUB_WORKSPACE/third_party/v8"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update crate version
        env:
          CRATE_VERSION: ${{ needs.detect.outputs.version }}
        shell: python
        run: |
          import os
          import pathlib
          import re

          version = os.environ.get("CRATE_VERSION")
          if not version:
              raise SystemExit("CRATE_VERSION is not defined")

          cargo_toml = pathlib.Path("Cargo.toml")
          content = cargo_toml.read_text(encoding="utf-8")
          pattern = re.compile(r'(?m)^(version\s*=\s*")([^"]+)(")')

          def replacer(match):
              return f"{match.group(1)}{version}{match.group(3)}"

          new_content, replaced = pattern.subn(replacer, content, count=1)
          if replaced == 0:
              raise SystemExit("Failed to update crate version in Cargo.toml")
          cargo_toml.write_text(new_content, encoding="utf-8")

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            clang \
            lld \
            ninja-build \
            pkg-config \
            bison \
            gperf \
            libffi-dev \
            libglib2.0-dev \
            libnss3 \
            libatk-bridge2.0-dev \
            libgtk-3-dev \
            libdrm-dev \
            libgbm-dev \
            libx11-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxdamage-dev \
            libxrandr-dev \
            libxtst-dev \
            libasound2-dev \
            libcups2-dev \
            libpci-dev \
            libpulse-dev

      - name: Install 32-bit toolchain (Linux)
        if: runner.os == 'Linux' && matrix.target_triple == 'i686-unknown-linux-gnu'
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y g++-multilib libc6-dev-i386 lib32stdc++6 lib32gcc-s1

      - name: Install AArch64 toolchain (Linux)
        if: runner.os == 'Linux' && matrix.target_triple == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install ninja pkg-config gnu-tar

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -Command "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; if (-not (Get-Command choco -ErrorAction SilentlyContinue)) { iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1')) }"
          choco install -y ninja llvm

      - name: Sync V8 checkout
        run: git -C third_party/v8 fetch --tags origin

      - name: Build V8 prebuilts
        env:
          GN_TARGET: ${{ matrix.gn_target }}
          TARGET_TRIPLE: ${{ matrix.target_triple }}
          V8_GIT_REVISION: ${{ needs.detect.outputs.commit }}
        run: python scripts/build_v8.py

      - name: Build pacm-v8 crate
        env:
          V8_PREBUILT_DIR: ${{ format('artifacts/v8-{0}', matrix.target_triple) }}
        run: cargo build --workspace

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ format('v8-{0}', matrix.target_triple) }}
          path: |
            ${{ format('artifacts/v8-{0}.tar.gz', matrix.target_triple) }}
            ${{ format('artifacts/v8-{0}', matrix.target_triple) }}

  release:
    needs:
      - detect
      - build
    if: ${{ needs.detect.outputs.should_build == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v8-${{ needs.detect.outputs.version }}
          name: V8 ${{ needs.detect.outputs.version }}
          files: artifacts/**/v8-*.tar.gz
          make_latest: true
          generate_release_notes: true
          body: |
            Automated prebuilts for V8 version ${{ needs.detect.outputs.version }}.

            Built from commit `${{ needs.detect.outputs.commit }}`.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
